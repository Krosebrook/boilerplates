# GEMINI.md

> Guidance for Google Gemini AI when working with the Boilerplates CLI project.

## Project Summary

**Boilerplates CLI** is a Python-based command-line tool for managing infrastructure templates. It generates production-ready configurations for Docker Compose, Terraform, Ansible, Kubernetes, and Packer from customizable templates.

- **Language:** Python 3.9+
- **Framework:** Typer (CLI) + Rich (UI) + Jinja2 (templating)
- **Version:** 0.0.7
- **License:** MIT

## Repository Structure

```
boilerplates/
├── cli/                    # Python CLI source code
│   ├── core/               # Core framework components
│   └── modules/            # Technology-specific modules
├── library/                # Template collections
│   └── compose/            # 33 Docker Compose templates
├── tests/                  # Test scripts
├── scripts/                # Installation scripts
└── docs/                   # Documentation
```

## Core Components

### Entry Point
- `cli/__main__.py` - CLI entry, auto-discovers modules

### Core Framework (`cli/core/`)
| File | Purpose |
|------|---------|
| `module.py` | Abstract base class for all modules |
| `template.py` | Template loading, parsing, rendering |
| `collection.py` | VariableCollection (sections + variables) |
| `section.py` | VariableSection dataclass |
| `variable.py` | Variable dataclass with validation |
| `config.py` | User configuration management |
| `display.py` | Centralized CLI output (use this for ALL output) |
| `prompt.py` | Interactive prompts (Rich library) |
| `validators.py` | Semantic validation (YAML, Docker Compose) |
| `exceptions.py` | Custom exception hierarchy |
| `library.py` | Multi-library template discovery |
| `repo.py` | Git repository sync |
| `registry.py` | Module auto-discovery registry |
| `version.py` | Semantic version utilities |

### Modules (`cli/modules/`)
Currently only Docker Compose is implemented:
- `compose/__init__.py` - ComposeModule class
- `compose/spec_v1_0.py` - Schema 1.0 variables
- `compose/spec_v1_1.py` - Schema 1.1 variables (network_mode, swarm)

**Planned modules:** Terraform, Docker, Ansible, Kubernetes, Packer

## Key Patterns

### 1. Output via DisplayManager
All CLI output MUST use `DisplayManager`:

```python
from cli.core.display import display

display.display_info("Message")
display.display_success("Success message")
display.display_error("Error message")
display.display_warning("Warning message")
```

### 2. Custom Exceptions
All errors use custom exceptions from `cli/core/exceptions.py`:

```python
from cli.core.exceptions import TemplateNotFoundError, VariableValidationError

raise TemplateNotFoundError(template_id="nginx", module_name="compose")
```

### 3. Template Structure
Each template is a directory containing:
- `template.yaml` - Metadata and variable specifications
- `*.j2` files - Jinja2 templates (rendered)
- Static files - Copied as-is

### 4. Module Registration
Modules self-register with the registry:

```python
from cli.core.module import Module
from cli.core.registry import registry

class MyModule(Module):
    name = "mymodule"
    description = "Module description"
    schema_version = "1.0"

registry.register(MyModule)
```

## Template YAML Schema

```yaml
---
kind: compose              # Module type
schema: "1.1"              # Schema version (optional, default 1.0)
metadata:
  name: Service Name
  description: |
    Multi-line description
  version: 1.0.0
  author: Author Name
  date: '2025-01-01'
  tags: [tag1, tag2]
  draft: false
spec:
  section_name:
    title: Display Title
    required: true/false
    toggle: bool_var_name   # Conditional section
    needs: [dep1, dep2]     # Section dependencies
    vars:
      variable_name:
        type: str/int/float/bool/email/url/hostname/enum
        default: value
        description: Help text
        prompt: Custom prompt
        sensitive: true/false
        autogenerated: true/false
        required: true/false
        optional: true/false
        options: [a, b, c]  # For enum type
```

## Variable Types

| Type | Description |
|------|-------------|
| `str` | String (default) |
| `int` | Integer |
| `float` | Floating point |
| `bool` | Boolean |
| `email` | Email (validated) |
| `url` | URL (requires scheme) |
| `hostname` | Domain/hostname |
| `enum` | Choice from options list |

## Common Commands

```bash
# Run CLI
python3 -m cli

# List templates
python3 -m cli compose list

# Show template details
python3 -m cli compose show nginx

# Generate template (interactive)
python3 -m cli compose generate nginx my-nginx

# Generate template (non-interactive)
python3 -m cli compose generate nginx my-nginx --no-interactive

# Dry-run generation
python3 -m cli compose generate nginx --dry-run

# Validate templates
python3 -m cli compose validate

# Debug mode
python3 -m cli --log-level DEBUG compose list

# Repository management
python3 -m cli repo list
python3 -m cli repo update
```

## Development Guidelines

### Code Style
- Python: PEP 8, 4-space indentation
- YAML: 2-space indentation, 160 char max line
- Docstrings: Google style
- Type hints: Required for public functions

### Linting
```bash
ruff check cli/    # Python linting
ruff format cli/   # Python formatting
yamllint .         # YAML linting
```

### Testing
```bash
./tests/test-compose-templates.sh
```

### Commit Messages
Format: `type(scope): subject`

Examples:
- `feat(compose): add new template`
- `fix(core): resolve variable parsing bug`
- `docs(readme): update installation instructions`
- `refactor(template): simplify rendering logic`

## Version Management

Version must be synchronized across:
1. `cli/__init__.py` - `__version__ = "0.0.7"`
2. `pyproject.toml` - `version = "0.0.7"`
3. `flake.nix` - `version = "0.0.7";`

## Dependencies

```
typer[all]>=0.9.0       # CLI framework
rich>=13.0.0            # Terminal UI
PyYAML>=6.0             # YAML parsing
python-frontmatter>=1.0 # Frontmatter support
Jinja2>=3.0             # Templating engine
```

## File Operations

### Adding a Template
1. Create `library/compose/mytemplate/`
2. Add `template.yaml` with metadata and variables
3. Add `compose.yaml.j2` (or other template files)
4. Run `python3 -m cli compose validate mytemplate`

### Adding a Module
1. Create `cli/modules/mymodule/` directory
2. Add `__init__.py` with Module subclass
3. Define `name`, `description`, `schema_version`
4. Optionally add spec files for multi-schema support
5. Register with `registry.register(MyModule)`

## Error Handling

Always use custom exceptions:
- `BoilerplatesError` - Base exception
- `ConfigError` / `ConfigValidationError`
- `TemplateError` / `TemplateNotFoundError` / `TemplateLoadError`
- `TemplateSyntaxError` / `TemplateValidationError` / `TemplateRenderError`
- `VariableError` / `VariableValidationError` / `VariableTypeError`
- `LibraryError` / `ModuleError` / `ModuleNotFoundError`
- `IncompatibleSchemaVersionError`
- `DuplicateTemplateError`
- `YAMLParseError`
- `FileOperationError`
- `RenderError`

## Important Notes

1. **DisplayManager is mandatory** - Never use print() directly
2. **Custom exceptions only** - Never use generic Exception
3. **Schema compatibility** - Templates must match module schema version
4. **Variable precedence** - CLI args > config > template > module defaults
5. **Linting required** - Run ruff and yamllint before commits

## Context for Assistance

When helping with this project:
- The CLI is ~7,600 lines of Python
- 33 Docker Compose templates exist
- Only Compose module is implemented
- Other modules (Terraform, Ansible, etc.) are planned
- Focus on `cli/` for core logic, `library/compose/` for templates

---

*This file provides context for Google Gemini AI to effectively assist with the Boilerplates CLI project.*
